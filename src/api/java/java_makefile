THIRDPARTY_DIR=../../../ThirdParty

#Protobuf sources (.proto)
PROTO_DIR=../protobufs

#Java directories  
JAVASRC_DIR=src/java
GRAVJAVASRC_DIR=$(JAVASRC_DIR)/com/aphysci/gravity
PROTOGENJAVA_DIR=$(GRAVJAVASRC_DIR)/protobuf/
#Generated Java source dir
SWIGGENJAVA_DIR=$(GRAVJAVASRC_DIR)/swig

#Java Output dir
JAVA_BUILD_DIR=build/

#Tools
PROTOC=../../../ThirdParty/bin/protoc

#Java Compiler Options
#classpath separator is different on UNIX and Windows
CLASSPATH_SEP=:
MY_CLASSPATH="$(THIRDPARTY_DIR)/lib/protobuf-java-2.4.1.jar$(CLASSPATH_SEP)build$(CLASSPATH_SEP)."

#Naming
JAR_NAME=gravity.jar

#Source/Object/Dependancies
CLASSES=$(patsubst $(GRAVJAVASRC_DIR)/%.java,$(JAVA_BUILD_DIR)/%.class,$(wildcard $(GRAVJAVASRC_DIR)/*.java))
GEN_CLASSES=$(patsubst $(SWIGGENJAVA_DIR)/%.java,$(JAVA_BUILD_DIR)/%.class,$(wildcard $(SWIGGENJAVA_DIR)/*.java))

#Protobuf Source/Generated Java/Objects
PROTO_SRC=$(PROTO_DIR)/GravityDataProductPB.proto
#PROTO_SRC=$(wildcard $(PROTO_DIR)/*PB.proto)
PROTO_JAVA=$(patsubst $(PROTO_DIR)/%PB.proto,$(PROTOGENJAVA_DIR)/%Container.java,$(PROTO_SRC))
PROTO_CLASS=$(patsubst $(PROTOGENJAVA_DIR)%.java,$(JAVA_BUILD_DIR)%.class,$(PROTO_JAVA))

.PRECIOUS: %.java $(PROTO_JAVA)

#proto src -> java
$(PROTOGENJAVA_DIR)/%Container.java: $(PROTO_DIR)/%PB.proto
	@echo $<
	@$(PROTOC) --proto_path=$(PROTO_DIR) --java_out=$(JAVASRC_DIR) $<

#protobuf java -> class
$(JAVA_BUILD_DIR)/%.class: $(PROTOGENJAVA_DIR)/%.java
	@echo $<
	@javac -d $(JAVA_BUILD_DIR) -cp $(MY_CLASSPATH) $<

#Generated java -> class
$(JAVA_BUILD_DIR)/%.class: $(SWIGGENJAVA_DIR)/%.java
	@echo $<
	@javac -d $(JAVA_BUILD_DIR) -cp $(MY_CLASSPATH) -sourcepath src/java $<

#Static java -> class
$(JAVA_BUILD_DIR)/%.class: $(GRAVJAVASRC_DIR)/%.java
	@echo $<
	@javac -d $(JAVA_BUILD_DIR) -cp $(MY_CLASSPATH) -sourcepath src/java $<

#Swig should have already run
#classes -> jar
$(JAR_NAME): $(PROTO_CLASS) $(CLASSES) $(GEN_CLASSES)
	jar cf $@ -C $(JAVA_BUILD_DIR) .

clean:
	rm -rf $(JAVA_BUILD_DIR)*.class $(PROTOGENJAVA_DIR)*Container.java
